## 连锁采集 数据包测试 (2025.2.12 23:00 - )

# >>>>>>>>>>>>>>> 2025.4.1标记为只读文件 <<<<<<<<<<<<<<<<<

## -进度 (*代码 **测试 #待定)
    *1.核心实现：
        *实现逻辑
            eg.用钻石镐或铁镐挖掘钻石矿石或粗铁
            工具不限+方块有限：对方块使用计分板，建立ID-int映射
            耐久处理：只对耐久魔咒进行计算处理，默认开启物品损坏保护(耐久为3停止连锁)

        *模拟连锁
            *原地生成标记为事件对象(*存储玩家UUID和*一个随机数Tag(表示唯一)和*方块映射)，*高空~10000生成盔甲架(*存储并匹配玩家手中的工具和*随机数Tag)，#记录附近49区块的强加载状况并临时强加载(注意：防止误判，需要区块绝对位置计分项(需要TICK检查))?暂不需要区块检测强加载?
            *3*3视追检测(向前最多4格)在目标位置放置活跃子标记(*存储该随机数Tag，*使用tag标记是否被遍历(活跃))
            *TICK：主标记匹配*玩家UUID和*盔甲架，*盔甲架匹配检查手持工具，*主标记定位子标记去执行，#活跃子标记根据随机数Tag匹配盔甲架和主标记，匹配通过后检测耐久度和活跃子标记数量，以盔甲架主手执行挖掘该处方块，并将连锁数量同步到damage，在主标记处生成物品和经验，然后检测3*3是否存在子标记并往空白处该方块位置拷贝标记，然后标记自己为休眠子标记

        *事件处理
            *极端情况：
                *玩家位移和退出：检测匹配的是否玩家在48格内
                *玩家背包调度：如上所述通过匹配手持实现，不通过则停止连锁
            *耐久度：如上所述每tick连锁一次，原版工具保持剩余3耐久停止连锁，原版盔甲及其特殊工具需要写标签排除，其余情况检测damage即可(不对模组物品作保证，仅检测原版还是检测模组或者设置shift触发连锁，需要个人设置)
            *物品组件联动：物品堆叠组件有tool、max_damage、max_stack_size等等，需要检测
            *饥饿值：常驻计分板，玩家连锁数量达到0.5饥饿值时给予1秒饥饿
            *魔咒：loot可以适用于多数魔咒，耐久度自行计算
            其他情况：
                #

        后续添加
            *右键触发：斧子、锹、锄头和剪刀需要特殊检测
            *锄头耕地自动种植副手内容，农田自动在中心位置水
            *搜索深度，挖掘数量和每TICK最大挖掘数量等等可以自定义
            *部分方块支持的触发方式不同，矿物在配置后可以平常化连锁，但是泥土、石头等方块不可以(必须shift触发)

            *平地连锁：只挖掘所在位置向上的部分
            1.20.5以上的版本添加魔咒：连锁采集、一键砍伐、自动收种等等魔咒(使用该魔咒物品可以自动连锁(单做一个版本))、自动冶炼(自动将附近物品冶炼，可配合连锁采集)
            1.20.5以下版本：可配置的自动冶炼(需消耗岩浆桶，可预先使用触发器装燃料，当燃料值为负时不可使用该功能，并且自动扣除岩浆桶，类似亮度扫描的火把消耗机制)

        配置项
            #是否需要匹配工具才可连锁
            *从玩家实际位置生成战利品/从方块实际位置生成战利品
            *是否自动补种
            #是否允许空手连锁(空手连锁仍遵循手持物品检测)
            *所有玩家设置均可被全局操控(开/关/由玩家决定)
            #damage修复(模组偶尔出现物品含damage:0的标签导致无法堆叠)
            
    *2.内测修复：
        内测：
            
        修复：
            *跨纬度转发有问题！转发器世界实体改为事件实体
        优化：
            1.减少宏和random的使用，做无组件版本，尝试突破宏限制向下兼容
                无组件版本：根据以往版本的NBT修改即可
                (*注意1.20.5 if items的替代：谓词(1.17之后才支持item数组，此前是字符串))
                低版本使用marker盔甲架代替marker
                尝试使用古老替换玩家背包物品大法，1.17继续向下兼容直到1.14
            #2.物品(检测ID和数量记录到计分板然后kill到最后生成)和经验值可以TICK最后处理，使用计分板记录
            7.各种情境下的连锁：
                *挖矿模式：一般流程的连锁采集
                *联合采集模式：所有矿石集合的连锁采集
                    若block_value为-1，则开启联合采集模式，所有种类的同类方块可全部连锁
                    将会先检测挖掘的方块分类，*木头类连锁木头，土壤类连锁土壤(无耕地)，树叶类连锁树叶，*矿石类连锁矿石，农作物连锁农作物，珊瑚块连锁珊瑚块
                    (实现逻辑：使用一个block_value映射匹配多个方块(每个分类需要两个配置文件))
                *砍伐模式：(放心种植大橡木！(*^▽^*))
                    *若挖掘原木，检测到周围有对应树叶且非持续，则启用泥土检测+补种树苗
                    实现逻辑：
                        *检测到附近有不持续树叶就加分/标签 (#replant / replant:1)，使用向下搜索(需要单独写)找到第一个泥土#dirt并标记
                        *检查玩家背包树苗，满足三个条件后自动补种，巨树需要标记每一个接触泥土的标记(最多64个,然后每个都需要向东南方检测)
                        *联合采集没有补种；补种功能支持配置；补种功能仅支持DFS
                *形状模式：(开启后必须潜行触发(递归记录方块位置变化来锁定位置))
                    启用形状模式后，激活1个触发器[主菜单中也显示](1：当前形状参数；101-109：宽1-9奇数；111-119：高1-9；121-129：深1-9；)；
                    a*b:宽*高(宽必须是奇数+高必须大于1) 深度默认1可由玩家配置 还可配置:挖掘模式(平齐(挖掘的矩形和玩家处在同一y平面)/中心(玩家挖掘的是矩形中心点))

                *互动模式：
                    #锹平地(和锄一样但没有放水)
                    *锄耕地(*副手拿水桶可以自动在中心位置放水,#可以修改模式(平面模式/强制模式 & 圆形模式/方形模式)修改半径(1-4))
                    *种子种地
                        模式配置：直线模式、3×3形状模式、平面bfs搜索模式
                        (只有直线模式支持瓜苗种子)开放触发器配置长度(直线&形状边长，对自动耕作也有效)
                    #斧去皮(连锁去皮、连锁除锈)

                *树叶快速腐烂：
                    距离为7的树叶使用BFS的方式腐烂(仅限玩家连锁的悬浮的树叶)，砍树后自动生成事件子标记(该事件无主标记)
                *自动补种模式：
                    采集农作物或*连锁树木后可自动连锁种植
                    (农作物组支持智能补种)
                #一键灌装模式：
                    BFS搜索液体装填直到装满背包
                安全性：
                    注意该模组和领地保护、出生点保护无法兼容
            *8.数据包安全性设计(禁止玩家手动调用影响效果,最后考虑)
            *8.5.所有功能在多人环境测试，在原版环境测试
            *9.配置文件可读性(使用计分项临时秘钥减少映射表文件，尽可能少的文件配置，优化api)；重新写reload和setting的prompt

    *3.要点总结：
        关于本数据包⚡[ATP高能连锁]：
            1.#
        关于连锁采集的玩家体验友好部分：
            1.开放API(整合到同一文件夹)，玩家可以自己添加工具和需要连锁的方块
            2.兼容数据包，支持原版物品堆叠组件(max_damage、tool的damage_per_damage)做的自定义工具的耐久消耗计算
            3.使用DFS尝试，当扫描到10倍线程数(默认为64*10=640)的目标方块时，将停止DFS转用BFS对象异步处理，防止卡线程(注意：即使耐久值不支持640连锁，也会根据方块数选择BFS球形连锁，毕竟DFS连锁的形状难以言说)
            4.限制最大线程数保证服务器不会因此崩溃
            5.单次事件线程数、最大线程数、最远距离、最大连锁数量、最大搜索深度等等都是可配置的
            6.物品和经验值可选择直接掉落或直接进入玩家背包
            7.耐久处理的优化，采用预期最大值和二项分布的数学期望计算：
            连锁前，计算预期最大数量：C=(M-D)*U/P   (M:最大耐久;D:当前损耗值;U:耐久魔咒等级+1;P:tool组件的damage_per_damage即每次消耗多少耐久)，实际数量等于C时退出
            连锁后，根据实际数量S (S≤C)计算耐久损耗，公式为 S*P/U，同时求出余数 R=S*P%U，并采用概率来确定是否需要耐久损耗额外+1 (从1~U抽取随机数R2，若R2≤R则需额外损耗1耐久)
            8.版本后瞻：为了向下兼容，已全部禁用了高版本MC支持的下列原生的强力命令：
            /random 生成随机值(使用物品修饰器随机值和均值替代)
            $$(str) 宏函数(用于为对象添加唯一映射ID，现使用随机实体UUID+计分板模拟实现；还用于经验球价值传参，现使用1~32767中的11个预设值和递归实现精确的经验数量生成，尽量保证经验球数量减少，以免花费大量时间吸取经验球；以及其他用途等)
            return 返回命令(用于条件判断、截停函数，现使用其他条件判断替代)
            以及execute if items子命令 (使用标签和谓词判断替代)等等其他低版本(1.17-1.20.1)不支持的替代
            9.对于大型矿脉，例如y=0的大型分散铁矿脉，连锁采集将(矿石、深层矿石、粗矿块绑定到了相同的ID上)可以让你发掘更多矿物

    *4.功能拓展：
        自动照明
            *1.背包中存在火把时，检测到小于7的亮度会自动消耗火把照明
            2.#亮度扫描(一次扫描范围不可以超过256区块)：两点确定一个区域，消耗火把点亮所有非液体可刷怪区域(可以自己指定亮度值) (暂不加入，需要1.20.2+)
        *数据包名字：ATP高能连锁
        #为数据包做进度：

    *5.兼容性警告：
        5-1.[在某些辅助类mod的影响下]使用无damage标签的一般物品去连锁采集，若连锁后，手持物品未改变状态(包括丢出、合并、nbt修改等等)，改成创造模式后，开启背包的一瞬间会为该手持物品添加{damage:0}标签，即使目前没手持也会修改那个物品
        5-2.数据包命令权限大于玩家，因此大概率会绕过领地插件对私人领地的保护去连锁，即不兼容领地功能
    
    *6.项目测试：
        (多人测试、原版端测试*、生电端测试)
        基础连锁，所有功能关闭：
            矿石、草，并监测耐久计算，剪刀剪草
        其他功能测试，自动照明测试

        完善配置文件和方块禁用模式
        
    *7.完善：
        *为数据包做几个引导性进度(建议不做AWA)
        *穷举并按版本分类方块类型(记得在README说明)
        *进行其他版本的测试
        *可配置的连锁数量显示

        *需要调整的版本兼容：
            错误的计分板和谓词以及execute谓词判断都会导致函数失效
            execute计分板判断不会导致函数失效
            1.计分板注册需要单开
            2.方块检测需要单开
            3.树苗匹配需要单开
            4.对于ID被修改的方块，上述匹配都需要单开；除此之外，计分板if score检测需要都存在前后版本的ID，tags需要写required:false
            5.种子和成熟农作物需要单开
            5.5.自动补种需要单开
            6.工具匹配需要单开(工具检查2和3)
            7.低版本无组件，需要检测NBT，修复耐久计算 *
            8.将数据包移植到1.17使用DHP检查问题(例如谓词items和tags) *

        *各版本方块信息：
            1.19更新：
                *红树，泥砖，幽匿，蛙鸣灯
            1.20更新：
                竹子，校频幽匿感测体，雕纹书架，悬挂告示牌，*樱花树，嗅探兽及其*植物，粉红花簇
            1.21更新：
                铜块建筑，凝灰岩建筑
                *重锤
            #1.21.4更新：(等待1.21.5)
                苍白橡树，树脂，眼眸花，嘎吱之心，苍白苔藓
            1.20.3更新：
                *草ID更改，short_grass

        *低版本兼容需要注意的问题：
            1.tags修改+谓词/进度修改 *
            2.部分函数引用的标签不存在，检测到黄线需要从minecraft添加对应tag *
            3.向1.17兼容需注意计分板全部混淆，改成16字符以下，虚拟实体同理
            4.雪球实体转发器改为其他方法检测特定UUID的玩家(仅在低版本修改即可)(可选用计分板存储UUID或遍历玩家UUID覆盖marker的data/UUID) *
            5.搜索.count，改为.Count，这是component不存在的情况下的遗漏情况(已标注#temppp) *
            6.dark_area群系谓词需要分版本，1.19才有深暗之域(仅低版本已取消群系监测) *
            7.低版本无commandModification规则，将移除光源方块的fill参数改为15，仅在低版本 *
            8.删除程序中，有两条规则，注意规则适用性

        分隔版本的必要情况：
            1.多数谓词或进度的语法改动较大，需要分离版本(1.20.5除外，物品组件相关版本，已做强制兼容)
            2.计分板命名规则被修改，如1.17，单做一个版本(高版本尽量有更好的可读性)
        
        版本情况：
            1.18-1.20.4  1.20.5-1.20.6  1.21-1.21.3

        发布前：
            1.穷举所有方块，并放到3个版本中(先无脑穷举，最后放入其他版本中纠错)
                所有组的tags和score  combination  配置文件  no_damage.json  经验中存在1.19+
                修改下reload提示和trigger提示：联合采集加上“等”，去掉“计-划中”
                    1.21-1.21.3*  1.20.5-1.20.6*  1.18-1.20.4*
            2.删除每个版本不必要的version部分(例如组件、NBT、进度格式等等)以及debug部分等等
              原有的方块数量过于庞大，将大量的方块转移到其他函数，配置文件保持清洁
                1.21-1.21.3*  1.20.5-1.20.6*  1.18-1.20.4*
            3.每个版本检查修改README default LICENSE pack.png
                1.21-1.21.3*  1.20.5-1.20.6*  1.18-1.20.4*

    8.版本更新：

        待修复的BUG和优化项：
            考虑中：
                1.基础功能允许玩家“自定”(考虑中)*
                2.链接正确跳转至MCMOD的模组页面(考虑中)*
                3.搜索量大于DFS尝试时，可自选是“放弃”还是“异步挖掘”
                4.使用模组包装数据包，作为全局服务端模组
            待修复：
                1.无法破坏的锄头无法范围耕地(暂时不修)
                2.将开发版本上传至Github并重新选择开源、描述附图:异步连锁(#temppp)
                3.配置项：是否保护工具(不保护、只保护附魔工具、保护)

        度盘链接：
            通过网盘分享的文件：ATP miner
            链接: **** 提取码: 3156

        下一版本：
            *1.21.4
            1.21.5
